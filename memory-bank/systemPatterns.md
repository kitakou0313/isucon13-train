# システムパターン

## システムアーキテクチャ

ISUPipeは以下の主要コンポーネントで構成されています：

```
[クライアント] <-> [Nginx] <-> [Node.js アプリケーション] <-> [MySQL データベース]
```

### コンポーネント詳細

1. **フロントエンド**
   - 静的ファイル（HTML, CSS, JavaScript）
   - Nginxによる配信

2. **バックエンド**
   - Node.js + TypeScript
   - Honoフレームワーク
   - RESTful API

3. **データストア**
   - MySQL データベース
   - ユーザー、ライブストリーム、コメント等のデータを保存

4. **インフラ**
   - Docker コンテナ
   - PowerDNS（サブドメイン管理）

## 主要技術決定

### Webフレームワーク: Hono
- 軽量で高速なWebフレームワーク
- TypeScriptとの相性が良い
- ミドルウェアによる拡張性

### データベース: MySQL
- リレーショナルデータベース
- トランザクション処理のサポート
- インデックスによるクエリ最適化

### 認証: セッションベース
- Cookie-based セッション管理
- bcryptによるパスワードハッシュ化

### コンテナ化: Docker
- 環境の一貫性確保
- ツール群の簡易実行
- デプロイの簡素化

## データモデル

### 主要エンティティ

1. **User**
   - ユーザー情報（ID, 名前, 表示名, パスワード, 説明）
   - アイコン画像
   - テーマ設定

2. **Livestream**
   - 配信情報（ID, タイトル, 説明, URL, サムネイル）
   - 開始・終了時間
   - 配信者（ユーザーID）
   - タグ

3. **Livecomment**
   - コメント内容
   - 投稿者（ユーザーID）
   - 配信（ライブストリームID）
   - 投げ銭額
   - 投稿時間

4. **Reaction**
   - リアクション種類（絵文字）
   - 投稿者（ユーザーID）
   - 配信（ライブストリームID）
   - 投稿時間

5. **NGWord**
   - フィルタリングワード
   - 設定者（ユーザーID）
   - 配信（ライブストリームID）

6. **LivecommentReport**
   - 報告対象コメント
   - 報告者（ユーザーID）
   - 配信（ライブストリームID）

7. **Tag**
   - タグ名
   - ライブストリームとの関連

8. **ReservationSlot**
   - 予約枠情報
   - 開始・終了時間

9. **LivestreamViewersHistory**
   - 視聴履歴
   - 視聴者（ユーザーID）
   - 配信（ライブストリームID）

## 主要データフロー

### ユーザー登録・認証フロー
1. ユーザーが登録情報を送信
2. パスワードがハッシュ化されてデータベースに保存
3. ログイン時に認証情報を検証
4. セッションを作成してCookieに保存

### ライブストリーム配信フロー
1. 配信者がライブストリームを予約
2. 予約情報がデータベースに保存
3. 配信開始時に配信URLが有効化
4. 視聴者が入室すると視聴履歴が記録

### コメント・リアクションフロー
1. ユーザーがコメント/リアクションを送信
2. NGワードチェックが実行される
3. データベースに保存
4. 他の視聴者に配信される

### モデレーションフロー
1. 配信者がNGワードを設定
2. ユーザーが不適切なコメントを報告
3. 報告情報がデータベースに保存
4. 配信者が報告を確認して対応

## パフォーマンス最適化ポイント

### データベース
- インデックス最適化
- クエリ効率化
- コネクションプール管理

### アプリケーション
- キャッシュ導入
- N+1クエリ問題の解決
- 非同期処理の活用

### Webサーバー
- 静的ファイルのキャッシュ
- gzip圧縮
- KeepAlive設定

### 監視・分析
- alpによるアクセスログ解析
- mysqlslowdumpによるスロークエリ分析
- pprofによるアプリケーションプロファイリング
